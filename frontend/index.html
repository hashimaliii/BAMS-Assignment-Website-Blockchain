<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>BAMS Hierarchy Dashboard</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;800&display=swap" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
    <style>
        /* Apply the Inter font globally */
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f4f7fa; /* Light background for the overall page */
        }
        
        /* Custom Tailwind Configuration for shadow and backgrounds */
        .container-bg {
            background-color: #ffffff; /* White card background */
            border: 1px solid #e5e7eb; /* Light border */
        }
        
        .card-shadow {
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -2px rgba(0, 0, 0, 0.06);
            transition: transform 0.2s, box-shadow 0.2s;
        }

        .card-shadow:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -4px rgba(0, 0, 0, 0.1);
        }

        /* Primary Button Style */
        .btn-primary {
            background-color: #3b82f6; /* Blue-600 */
            color: white;
            transition: background-color 0.15s ease-in-out;
        }
        
        .btn-primary:hover {
            background-color: #2563eb; /* Blue-700 */
        }

        /* Ensure sticky header looks good on scroll */
        header {
            background-color: #f4f7fa; /* Match body background */
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
        }

        /* Explicitly define hidden class to ensure it works */
        .hidden {
            display: none !important;
        }
    </style>
</head>
<body class="min-h-screen p-4 md:p-8">

    <div id="app" class="max-w-7xl mx-auto">
        
        <!-- Header & Global Actions -->
        <header class="container-bg p-6 mb-8 rounded-xl flex flex-col md:flex-row justify-between items-start md:items-center sticky top-0 z-10">
            <h1 class="text-3xl font-extrabold text-gray-800 mb-4 md:mb-0">
                <span class="text-blue-600">BAMS</span> Hierarchy Dashboard
            </h1>
            <div class="flex flex-wrap gap-3">
                <button id="validation-btn" class="btn-primary px-5 py-2 rounded-lg font-semibold text-sm shadow-md">
                    üõ°Ô∏è Run System Integrity Check
                </button>
                <button id="home-btn" class="bg-gray-200 text-gray-700 hover:bg-gray-300 px-5 py-2 rounded-lg font-semibold text-sm shadow-md" onclick="setView('departments')">
                    üè† Home
                </button>
                <button id="view-3d-btn" class="bg-purple-500 text-white hover:bg-purple-600 px-5 py-2 rounded-lg font-semibold text-sm shadow-md" onclick="setView('hierarchy3d')">
                    üéØ 3D Hierarchy Tree
                </button>
            </div>
        </header>

        <!-- Message/Status Area -->
        <div id="message-area" class="mb-6 p-4 rounded-lg text-sm transition-all duration-300 ease-in-out hidden"></div>

        <!-- Breadcrumbs -->
        <div id="breadcrumbs" class="mb-6 text-gray-600 text-sm font-medium"></div>

        <!-- Search Bar -->
        <div id="search-container" class="mb-6 flex gap-3">
            <input 
                type="text" 
                id="search-input" 
                placeholder="üîç Search departments, classes, or students..." 
                class="flex-1 px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500"
                oninput="performSearch(this.value)"
            />
            <button 
                id="clear-search-btn" 
                class="bg-gray-300 text-gray-700 hover:bg-gray-400 px-4 py-2 rounded-lg font-medium text-sm hidden"
                onclick="clearSearch()"
            >
                Clear
            </button>
        </div>

        <!-- Main Content Area -->
        <div id="main-content">
            <h2 class="text-2xl font-bold text-gray-700 mb-4" id="current-view-title">Departments</h2>
            
            <div id="loading-indicator" class="text-center py-12 text-gray-500 hidden">
                <div class="animate-spin inline-block w-8 h-8 border-4 border-blue-500 border-t-transparent rounded-full"></div>
                <p class="mt-2">Loading data...</p>
            </div>
            
            <!-- List View (Departments, Classes, Students) -->
            <div id="list-view" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                <!-- Content injected here -->
            </div>

            <!-- Attendance/History View (Student details and blockchain data) -->
            <div id="history-view" class="hidden">
                <!-- Student Details and Attendance Form -->
                <div id="student-details-card" class="container-bg p-6 rounded-xl mb-6 card-shadow"></div>
                
                <h3 class="text-xl font-bold text-gray-700 mb-3 mt-8">Blockchain Ledger (Student Chain)</h3>
                <div id="blockchain-data" class="space-y-4">
                    <!-- Blocks injected here -->
                </div>
            </div>

            <!-- 3D Hierarchy View -->
            <div id="hierarchy3d-view" class="hidden w-full">
                <div id="canvas-container" style="width: 100%; height: 600px; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);"></div>
                <div class="mt-4 p-4 bg-blue-50 rounded-lg">
                    <p class="text-sm text-gray-600"><strong>3D Hierarchy Controls:</strong></p>
                    <p class="text-xs text-gray-500 mt-2">
                        ‚Ä¢ Drag to rotate ‚Ä¢ Scroll to zoom ‚Ä¢ Right-click + drag to pan<br>
                        ‚Ä¢ Green nodes = Departments ‚Ä¢ Blue nodes = Classes ‚Ä¢ Orange nodes = Students
                    </p>
                </div>
            </div>
        </div>
    </div>

    <!-- Modals (Simple structure for demonstration) -->
    <div id="modal-container" class="hidden fixed inset-0 bg-gray-900 bg-opacity-50 flex items-center justify-center p-4 z-50">
        <div class="bg-white p-8 rounded-xl w-full max-w-lg">
            <h3 id="modal-title" class="text-xl font-bold mb-4">Modal Title</h3>
            <div id="modal-content">Modal Content</div>
            <div class="mt-6 flex justify-end gap-3">
                <button id="modal-close" class="bg-gray-300 text-gray-700 hover:bg-gray-400 px-4 py-2 rounded-lg">Close</button>
            </div>
        </div>
    </div>

    <script>
        const API_BASE_URL = '/api';
        
        // --- Application State ---
        let currentState = {
            view: 'departments', // 'departments', 'classes', 'students', 'history'
            deptId: null,
            className: null,
            classId: null,
            studentId: null,
            studentName: null,
        };
        
        // --- Utility Functions ---

        function showLoading(show) {
            console.log('[SHOW_LOADING]', show ? 'Showing spinner, hiding content' : 'Hiding spinner, showing content');
            document.getElementById('loading-indicator').classList.toggle('hidden', !show);
            
            // Only manage list-view visibility when NOT in history view
            // In history view, setView() and viewStudentChain() manage the visibility
            if (currentState.view !== 'history') {
                document.getElementById('list-view').classList.toggle('hidden', show);
            }
            
            // Only hide history-view when showing loading spinner
            // When hiding spinner, don't touch history-view - let setView() manage its visibility
            if (show) {
                document.getElementById('history-view').classList.add('hidden');
            } else {
                // If we're in history view, make sure it's visible
                if (currentState.view === 'history') {
                    document.getElementById('history-view').classList.remove('hidden');
                    console.log('[SHOW_LOADING] Restored history-view visibility for history view');
                }
            }
        }

        function showMessage(type, message, details = '') {
            const area = document.getElementById('message-area');
            
            // --- FIX FOR InvalidCharacterError (Issue 3) ---
            // 1. Remove ALL classes first to ensure a clean slate.
            area.className = 'mb-6 p-4 rounded-lg text-sm transition-all duration-300 ease-in-out';
            // 2. Add 'hidden' back if the message is empty (though it shouldn't be).
            if (!message) {
                area.classList.add('hidden');
                return;
            }
            
            let classes = [];
            if (type === 'error') {
                classes = ['bg-red-100', 'border', 'border-red-400', 'text-red-700'];
            } else if (type === 'success') {
                classes = ['bg-green-100', 'border', 'border-green-400', 'text-green-700'];
            } else if (type === 'info') {
                classes = ['bg-blue-100', 'border', 'border-blue-400', 'text-blue-700'];
            } else if (type === 'warning') {
                classes = ['bg-yellow-100', 'border', 'border-yellow-400', 'text-yellow-700'];
            }

            // Apply classes one by one to avoid issues with space characters
            classes.forEach(cls => area.classList.add(cls));
            
            area.innerHTML = `<strong>${message}</strong> ${details ? `<br><span class="block mt-1">${details}</span>` : ''}`;
            
            // Show the message area
            area.classList.remove('hidden');

            // Auto-hide success/info messages
            if (type === 'success' || type === 'info') {
                setTimeout(() => area.classList.add('hidden'), 5000);
            }
        }

        function buildPath(id, classId, studentId) {
            let url = API_BASE_URL;
            if (id) {
                url += `/departments/${id}`;
            }
            if (classId) {
                url += `/classes/${classId}`;
            }
            if (studentId) {
                url += `/students/${studentId}`;
            }
            return url;
        }

        async function fetchData(url, method = 'GET', body = null) {
            try {
                const options = {
                    method,
                    headers: { 'Content-Type': 'application/json' },
                };
                if (body) {
                    options.body = JSON.stringify(body);
                }

                const response = await fetch(url, options);
                
                if (response.status === 204) {
                    return { success: true, message: "Operation successful, no content returned." };
                }

                // Read the response body as text first; this lets us capture HTML response bodies (useful for debugging 404/5xx)
                const contentType = response.headers.get('content-type') || '';
                const textBody = await response.text();
                let data = null;
                if (contentType.includes('application/json')) {
                    try {
                        data = JSON.parse(textBody);
                    } catch (e) {
                        // If JSON parse fails unexpectedly, add the raw text for inspection
                        throw new Error(`Invalid JSON from server: ${textBody.substring(0, 200)}`);
                    }
                } else {
                    // Non-JSON response (HTML or text) ‚Äî include raw body in error to surface server response
                    throw new Error(`Non-JSON response from server (status ${response.status}). Body: ${textBody.substring(0, 200)}`);
                }

                if (!response.ok) {
                    // Handle 400 Bad Request
                    if (response.status === 400) {
                         throw new Error(`Bad Request (400): ${data.error || 'Server rejected the request. Check your input.'}`);
                    }
                    // Check if it's a 500 error from validation and provide a specific message
                    if (response.status === 500 && url.endsWith('/validate')) {
                        throw new Error(`System validation failed on the server side (500 Error). Report: ${JSON.stringify(data.report || data.error)}`);
                    }
                    throw new Error(data.error || `HTTP error! Status: ${response.status}`);
                }
                
                return data;
            } catch (error) {
                console.error("Fetch Error:", error);
                // The fix in showMessage allows this to display correctly now
                showMessage('error', `API Request Failed:`, error.message);
                return null;
            }
        }

        // --- View Logic ---

        function updateBreadcrumbs() {
            let html = '<span class="cursor-pointer hover:text-blue-600" onclick="setView(\'departments\')">Departments</span>';
            
            if (currentState.deptId) {
                // Attempt to find the department name from the currently rendered cards if possible
                const deptCard = document.querySelector(`.dept-card[data-id="${currentState.deptId}"]`);
                const deptName = deptCard ? deptCard.querySelector('h3').textContent : currentState.deptId;

                html += ` <span class="mx-1">/</span> <span class="cursor-pointer hover:text-blue-600" onclick="setView('classes', '${currentState.deptId}')">${deptName}</span>`;
            }

            if (currentState.classId) {
                html += ` <span class="mx-1">/</span> <span class="cursor-pointer hover:text-blue-600" onclick="setView('students', '${currentState.deptId}', '${currentState.classId}')">${currentState.classId}</span>`;
            }

            if (currentState.view === 'history') {
                html += ` <span class="mx-1">/</span> <span class="text-blue-600">${currentState.studentName || currentState.studentId} (Ledger)</span>`;
            }
            document.getElementById('breadcrumbs').innerHTML = html;
        }


        function setView(view, deptId = null, classId = null, studentId = null, studentName = null) {
            currentState.view = view;
            currentState.deptId = deptId;
            currentState.classId = classId;
            currentState.studentId = studentId;
            currentState.studentName = studentName;
            
            // Hide all content containers
            document.getElementById('list-view').classList.remove('hidden');
            document.getElementById('history-view').classList.add('hidden');
            document.getElementById('hierarchy3d-view').classList.add('hidden');
            
            document.getElementById('list-view').innerHTML = '';
            
            document.getElementById('list-view').classList.remove('grid-cols-1', 'md:grid-cols-2', 'lg:grid-cols-3');
            
            switch (view) {
                case 'departments':
                    document.getElementById('current-view-title').textContent = 'Departments (Layer 1 Chains)';
                    document.getElementById('list-view').classList.add('grid-cols-1', 'md:grid-cols-2', 'lg:grid-cols-3');
                    fetchDepartments();
                    break;
                case 'classes':
                    document.getElementById('current-view-title').textContent = `Classes in ${deptId} (Layer 2 Chains)`;
                    document.getElementById('list-view').classList.add('grid-cols-1', 'md:grid-cols-2');
                    fetchClasses(deptId);
                    break;
                case 'students':
                    document.getElementById('current-view-title').textContent = `Students in ${classId} (Layer 3 Chains)`;
                    document.getElementById('list-view').classList.add('grid-cols-1'); // Student list is better as a single column table/list
                    fetchStudents(deptId, classId);
                    break;
                case 'history':
                    document.getElementById('current-view-title').textContent = `Attendance Ledger for ${studentName || studentId}`;
                    document.getElementById('list-view').classList.add('hidden');
                    document.getElementById('history-view').classList.remove('hidden');
                    fetchStudentHistory(deptId, classId, studentId, studentName);
                    break;
                case 'hierarchy3d':
                    document.getElementById('current-view-title').textContent = '3D Hierarchy Tree - All Departments, Classes & Students';
                    document.getElementById('list-view').classList.add('hidden');
                    document.getElementById('hierarchy3d-view').classList.remove('hidden');
                    // Clear previous canvas
                    const container = document.getElementById('canvas-container');
                    if (container.firstChild && container.firstChild.tagName === 'CANVAS') {
                        container.removeChild(container.firstChild);
                    }
                    setTimeout(() => init3DVisualization(), 100);
                    break;
            }
            updateBreadcrumbs();
        }

        // --- Search Functionality ---
        
        let allData = {
            departments: [],
            allClasses: {},  // deptId -> classes
            allStudents: {}   // classId -> students
        };

        async function performSearch(query) {
            const searchInput = document.getElementById('search-input');
            const clearBtn = document.getElementById('clear-search-btn');
            
            query = query.toLowerCase().trim();
            
            // Show/hide clear button
            clearBtn.classList.toggle('hidden', !query);
            
            if (!query) {
                clearBtn.classList.add('hidden');
                return; // User cleared the search
            }
            
            // Fetch all data if not already loaded
            if (allData.departments.length === 0) {
                await loadAllSearchData();
            }
            
            const results = searchAcrossLayers(query);
            displaySearchResults(results, query);
        }

        async function loadAllSearchData() {
            try {
                // Fetch all departments
                const depts = await fetchData(`${API_BASE_URL}/departments`);
                allData.departments = depts || [];
                
                // Fetch all classes for each department
                for (const dept of allData.departments) {
                    const classes = await fetchData(`${API_BASE_URL}/departments/${dept.id}/classes`);
                    allData.allClasses[dept.id] = classes || [];
                    
                    // Fetch all students for each class
                    for (const cls of (classes || [])) {
                        const students = await fetchData(`${API_BASE_URL}/departments/${dept.id}/classes/${cls.id}/students`);
                        allData.allStudents[cls.id] = students || [];
                    }
                }
            } catch (error) {
                console.error('Error loading search data:', error);
            }
        }

        function searchAcrossLayers(query) {
            const results = {
                departments: [],
                classes: [],
                students: []
            };
            
            // Search departments
            results.departments = allData.departments.filter(dept =>
                dept.name.toLowerCase().includes(query) ||
                dept.id.toLowerCase().includes(query)
            );
            
            // Search classes
            for (const deptId in allData.allClasses) {
                const classes = allData.allClasses[deptId];
                const matchedClasses = classes.filter(cls =>
                    cls.name.toLowerCase().includes(query) ||
                    cls.id.toLowerCase().includes(query)
                );
                
                for (const cls of matchedClasses) {
                    results.classes.push({ ...cls, deptId });
                }
            }
            
            // Search students
            for (const classId in allData.allStudents) {
                const students = allData.allStudents[classId];
                const matchedStudents = students.filter(student =>
                    student.name.toLowerCase().includes(query) ||
                    student.id.toLowerCase().includes(query) ||
                    student.rollNumber?.toString().includes(query)
                );
                
                // Get deptId from classId format (e.g., "COMP-C1-S01" -> "COMP")
                const deptId = classId.split('-')[0];
                
                for (const student of matchedStudents) {
                    results.students.push({ ...student, deptId, classId });
                }
            }
            
            return results;
        }

        function displaySearchResults(results, query) {
            document.getElementById('current-view-title').textContent = `Search Results for "${query}"`;
            
            let html = '<div class="space-y-8">';
            
            // Departments
            if (results.departments.length > 0) {
                html += `<div>
                    <h3 class="text-lg font-bold text-blue-600 mb-3">Departments (${results.departments.length})</h3>
                    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">`;
                
                html += results.departments.map(dept => `
                    <div class="container-bg p-4 rounded-lg card-shadow flex flex-col justify-between">
                        <div>
                            <h4 class="font-bold text-blue-600">${highlightMatch(dept.name, query)}</h4>
                            <p class="text-xs text-gray-500">ID: ${dept.id}</p>
                        </div>
                        <button class="mt-3 bg-blue-500 text-white hover:bg-blue-600 px-3 py-1 rounded text-sm" onclick="setView('classes', '${dept.id}')">
                            View Classes
                        </button>
                    </div>
                `).join('');
                
                html += '</div></div>';
            }
            
            // Classes
            if (results.classes.length > 0) {
                html += `<div>
                    <h3 class="text-lg font-bold text-green-600 mb-3">Classes (${results.classes.length})</h3>
                    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">`;
                
                html += results.classes.map(cls => `
                    <div class="container-bg p-4 rounded-lg card-shadow flex flex-col justify-between">
                        <div>
                            <h4 class="font-bold text-green-600">${highlightMatch(cls.name, query)}</h4>
                            <p class="text-xs text-gray-500">ID: ${cls.id}</p>
                            <p class="text-xs text-gray-400">Dept: ${cls.deptId}</p>
                        </div>
                        <button class="mt-3 bg-green-500 text-white hover:bg-green-600 px-3 py-1 rounded text-sm" onclick="setView('students', '${cls.deptId}', '${cls.id}')">
                            View Students
                        </button>
                    </div>
                `).join('');
                
                html += '</div></div>';
            }
            
            // Students
            if (results.students.length > 0) {
                html += `<div>
                    <h3 class="text-lg font-bold text-orange-600 mb-3">Students (${results.students.length})</h3>
                    <div class="space-y-2">`;
                
                html += results.students.map(student => `
                    <div class="container-bg p-3 rounded-lg card-shadow flex justify-between items-center">
                        <div>
                            <p class="font-medium text-orange-600">${highlightMatch(student.name, query)}</p>
                            <p class="text-xs text-gray-500">ID: ${student.id} | Roll: ${student.rollNumber} | Class: ${student.classId}</p>
                        </div>
                        <button class="bg-orange-500 text-white hover:bg-orange-600 px-3 py-1 rounded text-sm" onclick="setView('history', '${student.deptId}', '${student.classId}', '${student.id}', '${student.name}')">
                            View Ledger
                        </button>
                    </div>
                `).join('');
                
                html += '</div></div>';
            }
            
            if (results.departments.length === 0 && results.classes.length === 0 && results.students.length === 0) {
                html += '<p class="text-center text-gray-500 py-8">No results found for your search.</p>';
            }
            
            html += '</div>';
            
            document.getElementById('list-view').innerHTML = html;
            document.getElementById('list-view').classList.remove('hidden');
        }

        function highlightMatch(text, query) {
            const regex = new RegExp(`(${query})`, 'gi');
            return text.replace(regex, '<mark style="background-color: #fbbf24;">$1</mark>');
        }

        function clearSearch() {
            document.getElementById('search-input').value = '';
            document.getElementById('clear-search-btn').classList.add('hidden');
            setView('departments');
        }

        // --- API Calls and Renderers ---

        async function fetchDepartments() {
            showLoading(true);
            const data = await fetchData(`${API_BASE_URL}/departments`);
            showLoading(false);
            
            if (data) {
                document.getElementById('list-view').innerHTML = renderDepartmentList(data);
            }
        }

        function renderDepartmentList(departments) {
            let html = departments.map(dept => `
                <div class="dept-card container-bg p-6 rounded-xl card-shadow flex flex-col justify-between" data-id="${dept.id}">
                    <div>
                        <h3 class="text-xl font-bold text-blue-600 mb-1">${dept.name}</h3>
                        <p class="text-gray-500 text-sm">ID: ${dept.id}</p>
                        <p class="text-xs text-gray-400 mt-2 truncate">Latest Hash: ${dept.currentHash}</p>
                    </div>
                    <div class="mt-4 flex flex-col gap-2">
                        <button class="btn-primary w-full px-3 py-1 rounded-lg text-sm font-medium" onclick="setView('classes', '${dept.id}')">
                            View Classes (Layer 2)
                        </button>
                        <div class="flex gap-2">
                            <button class="bg-yellow-500 text-white hover:bg-yellow-600 px-3 py-1 rounded-lg text-xs" onclick="openCrudModal('Update Department', 'PUT', '${dept.id}')">Edit</button>
                            <button class="bg-red-500 text-white hover:bg-red-600 px-3 py-1 rounded-lg text-xs" onclick="confirmDelete('Department', '${dept.id}')">Delete</button>
                        </div>
                    </div>
                </div>
            `).join('');

            // Add button for creating new department
            html += `
                <div class="bg-white border-2 border-dashed border-gray-300 rounded-xl p-6 flex items-center justify-center cursor-pointer hover:bg-gray-50 transition duration-150"
                     onclick="openCrudModal('Add New Department', 'POST')">
                    <span class="text-gray-500 text-lg font-medium">+ Add Department</span>
                </div>
            `;
            return html;
        }

        async function fetchClasses(deptId) {
            showLoading(true);
            const data = await fetchData(`${API_BASE_URL}/departments/${deptId}/classes`);
            showLoading(false);
            
            if (data) {
                document.getElementById('list-view').innerHTML = renderClassList(data, deptId);
            }
        }

        function renderClassList(classes, deptId) {
            let html = classes.map(cls => `
                <div class="container-bg p-6 rounded-xl card-shadow flex flex-col justify-between">
                    <div>
                        <h3 class="text-xl font-bold text-green-600 mb-1">${cls.name}</h3>
                        <p class="text-gray-500 text-sm">ID: ${cls.id}</p>
                        <p class="text-xs text-gray-400 mt-2 truncate">Latest Hash: ${cls.currentHash}</p>
                    </div>
                    <div class="mt-4 flex flex-col gap-2">
                        <button class="btn-primary w-full px-3 py-1 rounded-lg text-sm font-medium" onclick="setView('students', '${deptId}', '${cls.id}')">
                            View Students (Layer 3)
                        </button>
                        <div class="flex gap-2">
                            <button class="bg-yellow-500 text-white hover:bg-yellow-600 px-3 py-1 rounded-lg text-xs" onclick="openCrudModal('Update Class', 'PUT', '${deptId}', '${cls.id}')">Edit</button>
                            <button class="bg-red-500 text-white hover:bg-red-600 px-3 py-1 rounded-lg text-xs" onclick="confirmDelete('Class', '${deptId}', '${cls.id}')">Delete</button>
                        </div>
                    </div>
                </div>
            `).join('');

            html += `
                <div class="bg-white border-2 border-dashed border-gray-300 rounded-xl p-6 flex items-center justify-center cursor-pointer hover:bg-gray-50 transition duration-150"
                     onclick="openCrudModal('Add New Class', 'POST', '${deptId}')">
                    <span class="text-gray-500 text-lg font-medium">+ Add Class</span>
                </div>
            `;
            return html;
        }

        async function fetchStudents(deptId, classId) {
            showLoading(true);
            const data = await fetchData(`${API_BASE_URL}/departments/${deptId}/classes/${classId}/students`);
            showLoading(false);

            if (data) {
                document.getElementById('list-view').innerHTML = renderStudentList(data, deptId, classId);
            }
        }

        function renderStudentList(students, deptId, classId) {
            let html = `
                <div class="lg:col-span-3">
                <div class="bg-white p-6 rounded-xl card-shadow overflow-x-auto">
                    <table class="min-w-full divide-y divide-gray-200">
                        <thead class="bg-gray-50">
                            <tr>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Name</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Roll No</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Student ID</th>
                                <th class="px-6 py-3 text-center text-xs font-medium text-gray-500 uppercase tracking-wider">Attendance</th>
                                <th class="px-6 py-3 text-center text-xs font-medium text-gray-500 uppercase tracking-wider">Actions</th>
                            </tr>
                        </thead>
                        <tbody class="divide-y divide-gray-200">
            `;

            if (students.length === 0) {
                html += `<tr><td colspan="5" class="p-4 text-center text-gray-500">No students found.</td></tr>`;
            } else {
                html += students.map(student => `
                    <tr class="hover:bg-gray-50">
                        <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">${student.name}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${student.rollNumber}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${student.id}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-center">
                            <select id="status-${student.id}" class="p-1 border rounded text-sm focus:ring-blue-500 focus:border-blue-500">
                                <option value="Present">Present</option>
                                <option value="Absent">Absent</option>
                                <option value="Leave">Leave</option>
                            </select>
                            <button class="bg-blue-500 text-white hover:bg-blue-600 px-3 py-1 ml-2 rounded text-xs font-medium" 
                                onclick="markAttendance('${deptId}', '${classId}', '${student.id}')">Mark</button>
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap text-center text-sm font-medium">
                            <button class="text-blue-600 hover:text-blue-900 text-xs mr-3" onclick="setView('history', '${deptId}', '${classId}', '${student.id}', '${student.name}')">View Ledger</button>
                            <button class="text-purple-600 hover:text-purple-900 text-xs mr-3" onclick="viewStudentChain('${deptId}', '${classId}', '${student.id}', '${student.name}')">View Chain</button>
                            <button class="text-yellow-600 hover:text-yellow-900 text-xs mr-3" onclick="openCrudModal('Update Student', 'PUT', '${deptId}', '${classId}', '${student.id}')">Edit</button>
                            <button class="text-red-600 hover:text-red-900 text-xs" onclick="confirmDelete('Student', '${deptId}', '${classId}', '${student.id}')">Delete</button>
                        </td>
                    </tr>
                `).join('');
            }

            html += `
                        </tbody>
                    </table>
                </div>
                
                <div class="mt-4">
                    <button class="bg-gray-200 text-gray-700 hover:bg-gray-300 px-4 py-2 rounded-lg font-semibold text-sm shadow-md"
                        onclick="openCrudModal('Add New Student', 'POST', '${deptId}', '${classId}')">
                        + Add Student
                    </button>
                </div>
            </div>`;
            return html;
        }

        // --- CRUD and Attendance Functions ---

        function openCrudModal(title, method, deptId, classId = null, itemId = null) {
            const container = document.getElementById('modal-container');
            const modalTitle = document.getElementById('modal-title');
            const modalContent = document.getElementById('modal-content');
            
            modalTitle.textContent = title;
            modalContent.innerHTML = `
                <form id="crud-form">
                    ${title.includes('Department') ? `
                        <label class="block text-gray-700 text-sm font-bold mb-2">Department ID</label>
                        <input type="text" name="deptId" class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 mb-4" placeholder="e.g., MATH" value="${itemId || ''}" ${itemId && method === 'PUT' ? 'disabled' : ''}>
                        <label class="block text-gray-700 text-sm font-bold mb-2">Department Name</label>
                        <input type="text" name="name" class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 mb-4" placeholder="e.g., School of Mathematics">
                    ` : title.includes('Class') ? `
                        <p class="text-xs text-gray-500 mb-4">Under Department: <strong>${deptId}</strong></p>
                        <label class="block text-gray-700 text-sm font-bold mb-2">Class ID</label>
                        <input type="text" name="classId" class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 mb-4" placeholder="e.g., MATH-101">
                        <label class="block text-gray-700 text-sm font-bold mb-2">Class Name</label>
                        <input type="text" name="name" class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 mb-4" placeholder="e.g., Calculus I">
                    ` : title.includes('Student') ? `
                        <p class="text-xs text-gray-500 mb-4">Under Class: <strong>${classId}</strong></p>
                        <label class="block text-gray-700 text-sm font-bold mb-2">Student ID</label>
                        <input type="text" name="studentId" class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 mb-4" placeholder="e.g., S-001" value="${itemId || ''}" ${method === 'PUT' ? 'disabled' : ''}>
                        <label class="block text-gray-700 text-sm font-bold mb-2">Name</label>
                        <input type="text" name="name" class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 mb-4" placeholder="e.g., Jane Doe">
                        <label class="block text-gray-700 text-sm font-bold mb-2">Roll Number</label>
                        <input type="number" name="rollNumber" class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 mb-4" placeholder="e.g., 20251001">
                    ` : `
                        <p class="text-xs text-gray-500 mb-4">Generic update form. Only submit fields you wish to change.</p>
                        <label class="block text-gray-700 text-sm font-bold mb-2">Name</label>
                        <input type="text" name="name" class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 mb-4" placeholder="New Name">
                    `}
                    <button type="submit" class="btn-primary w-full py-2 rounded-lg font-semibold mt-4">Submit</button>
                </form>
            `;

            document.getElementById('modal-close').onclick = () => container.classList.add('hidden');
            
            document.getElementById('crud-form').onsubmit = (e) => handleCrudSubmit(e, method, deptId, classId, itemId);

            container.classList.remove('hidden');
        }

        async function handleCrudSubmit(e, method, deptId, classId, itemId) {
            e.preventDefault();
            const form = e.target;
            const formData = new FormData(form);
            const body = {};
            
            // Collect all form fields first
            const allFields = {};
            formData.forEach((value, key) => {
                allFields[key] = value;
            });

            // Get the title from modal to determine what we're doing
            const title = document.getElementById('modal-title').textContent;

            // Filter body to only include relevant fields based on context
            if (method === 'POST') {
                if (title.includes('Department')) { // Adding Department
                    body.deptId = allFields.deptId;
                    body.name = allFields.name;
                } else if (title.includes('Class')) { // Adding Class
                    body.classId = allFields.classId;
                    body.name = allFields.name;
                } else if (title.includes('Student')) { // Adding Student
                    body.studentId = allFields.studentId;
                    body.name = allFields.name;
                    body.rollNumber = allFields.rollNumber;
                }
            } else if (method === 'PUT') {
                // For updates, include all non-empty fields except IDs
                for (const key in allFields) {
                    if (key !== 'deptId' && key !== 'classId' && key !== 'studentId' && allFields[key]) {
                        body[key] = allFields[key];
                    }
                }
            }

            // Determine URL
            let url = '';
            if (method === 'POST') {
                if (title.includes('Department')) { // Add Department
                    url = `${API_BASE_URL}/departments`;
                } else if (title.includes('Class')) { // Add Class
                    url = `${API_BASE_URL}/departments/${deptId}/classes`;
                } else if (title.includes('Student')) { // Add Student
                    url = `${API_BASE_URL}/departments/${deptId}/classes/${classId}/students`;
                }
            } else if (method === 'PUT') {
                if (title.includes('Department')) { // Update Department
                    url = buildPath(deptId);
                } else if (title.includes('Class')) { // Update Class
                    url = buildPath(deptId, classId);
                } else if (title.includes('Student')) { // Update Student
                    url = buildPath(deptId, classId, itemId);
                }
            }

            const result = await fetchData(url, method, body);
            document.getElementById('modal-container').classList.add('hidden');

            if (result) {
                showMessage('success', result.message);
                // Determine what to refresh based on title
                if (title.includes('Department')) {
                    setView('departments');
                } else if (title.includes('Class')) {
                    setView('classes', deptId);
                } else if (title.includes('Student')) {
                    setView('students', deptId, classId);
                } else {
                    setView(currentState.view, currentState.deptId, currentState.classId);
                }
            }
        }

        function confirmDelete(type, deptId, classId = null, itemId = null) {
            const name = itemId || classId || deptId;
            // Using a simple window.confirm as a temporary placeholder for a custom modal
            if (window.confirm(`Are you sure you want to logically delete ${type} [${name}]? This action creates an immutable 'deleted' block.`)) {
                handleDelete(type, deptId, classId, itemId);
            }
        }

        async function handleDelete(type, deptId, classId = null, itemId = null) {
            let url = '';
            if (type === 'Department') {
                url = buildPath(deptId);
            } else if (type === 'Class') {
                url = buildPath(deptId, classId);
            } else if (type === 'Student') {
                url = buildPath(deptId, classId, itemId);
            }

            // The backend error should be resolved by correcting the service file.
            const result = await fetchData(url, 'DELETE');
            
            if (result) {
                showMessage('success', result.message);
                // Refresh the current view
                setView(currentState.view, currentState.deptId, currentState.classId);
            }
        }


        async function markAttendance(deptId, classId, studentId) {
            const status = document.getElementById(`status-${studentId}`).value;
            const url = buildPath(deptId, classId, studentId) + '/attendance';
            
            const result = await fetchData(url, 'POST', { status });

            if (result) {
                showMessage('success', `Attendance marked as ${status}. Block Hash:`, result.blockHash.substring(0, 10) + '...');
            }
        }

        // --- History and Validation ---

        async function fetchStudentHistory(deptId, classId, studentId, studentName) {
            console.log('[FETCH_HISTORY] Called with:', { deptId, classId, studentId, studentName });
            document.getElementById('student-details-card').innerHTML = `
                <p class="text-xl font-bold">${studentName}</p>
                <p class="text-gray-500">ID: ${studentId} | Class: ${classId} | Dept: ${deptId}</p>
            `;
            
            showLoading(true);
            const url = buildPath(deptId, classId, studentId) + '/history';
            console.log('[FETCH_HISTORY] Requesting URL:', url);
            const data = await fetchData(url);
            console.log('[FETCH_HISTORY] Response data:', data);
            showLoading(false);

            const blockchainDataEl = document.getElementById('blockchain-data');
            console.log('[FETCH_HISTORY] blockchainDataEl:', blockchainDataEl);
            console.log('[FETCH_HISTORY] history-view hidden status:', document.getElementById('history-view').classList.contains('hidden'));
            blockchainDataEl.innerHTML = '';

            if (data && data.history) {
                if (data.history.length === 0) {
                    blockchainDataEl.innerHTML = '<p class="text-center text-gray-500 p-8">No attendance records found. Mark attendance to see records here.</p>';
                    console.log('[FETCH_HISTORY] No records found');
                    return;
                }
                console.log('[FETCH_HISTORY] Found', data.history.length, 'attendance records');
                
                let htmlContent = '';
                data.history.forEach((block, idx) => {
                    console.log(`[FETCH_HISTORY] Rendering block ${idx}:`, block);
                    const blockType = block.transactions?.type;
                    const isAttendance = blockType === 'ATTENDANCE_RECORD';
                    const attendanceStatus = block.transactions?.status || block.status;
                    
                    let statusColor = 'bg-gray-100 border-gray-300';
                    let statusIcon = '‚ÑπÔ∏è';

                    if (isAttendance) {
                        if (attendanceStatus === 'Present') {
                            statusColor = 'bg-green-100 border-green-300';
                            statusIcon = '‚úÖ';
                        } else if (attendanceStatus === 'Absent') {
                            statusColor = 'bg-red-100 border-red-300';
                            statusIcon = '‚ùå';
                        } else if (attendanceStatus === 'Leave') {
                            statusColor = 'bg-yellow-100 border-yellow-300';
                            statusIcon = 'üü°';
                        }
                    } else if (blockType && blockType.includes('DELETE')) {
                        statusColor = 'bg-red-100 border-red-300';
                        statusIcon = 'üóëÔ∏è';
                    }

                    htmlContent += `
                        <div class="${statusColor} p-4 rounded-lg border-l-4 card-shadow">
                            <div class="flex justify-between items-start">
                                <span class="font-bold text-lg">${statusIcon} Block #${block.index} (${blockType})</span>
                                <span class="text-xs text-gray-500">${new Date(block.timestamp).toLocaleString()}</span>
                            </div>
                            
                            <p class="mt-2 text-sm text-gray-700"><strong>Status:</strong> ${attendanceStatus || 'Metadata Update'}</p>
                            <p class="text-sm text-gray-700"><strong>Date:</strong> ${block.date || 'N/A'}</p>
                            
                            <p class="text-xs text-gray-500 mt-3 break-all"><strong>Hash:</strong> ${block.hash}</p>
                            <p class="text-xs text-gray-500 break-all"><strong>Prev Hash:</strong> ${block.prev_hash || '---'}</p>
                            <p class="text-xs text-gray-500"><strong>Nonce:</strong> ${block.nonce || '---'}</p>
                        </div>
                    `;
                });
                
                console.log('[FETCH_HISTORY] Setting innerHTML with', data.history.length, 'blocks');
                blockchainDataEl.innerHTML = htmlContent;
                console.log('[FETCH_HISTORY] innerHTML set. Element now contains:', blockchainDataEl.innerHTML.length, 'characters');
            } else {
                blockchainDataEl.innerHTML = '<p class="text-center text-gray-500 p-8">No blockchain data found for this student.</p>';
            }
        }

        async function viewStudentChain(deptId, classId, studentId, studentName) {
            // First, set up the view properly (similar to fetchStudentHistory)
            currentState.view = 'history';
            currentState.deptId = deptId;
            currentState.classId = classId;
            currentState.studentId = studentId;
            currentState.studentName = studentName;
            
            document.getElementById('current-view-title').textContent = `Complete Blockchain for ${studentName || studentId}`;
            
            // Explicitly hide and show the right divs
            const listView = document.getElementById('list-view');
            const historyView = document.getElementById('history-view');
            
            console.log('[VIEW_CHAIN] Before: list-view hidden =', listView.classList.contains('hidden'), ', history-view hidden =', historyView.classList.contains('hidden'));
            
            listView.classList.add('hidden');
            historyView.classList.remove('hidden');
            
            console.log('[VIEW_CHAIN] After: list-view hidden =', listView.classList.contains('hidden'), ', history-view hidden =', historyView.classList.contains('hidden'));
            
            console.log('[VIEW_CHAIN] Called with:', { deptId, classId, studentId, studentName });
            document.getElementById('student-details-card').innerHTML = `
                <p class="text-xl font-bold">${studentName}</p>
                <p class="text-gray-500">ID: ${studentId} | Class: ${classId} | Dept: ${deptId}</p>
                <p class="text-xs text-blue-600 mt-2">Viewing Complete Blockchain</p>
            `;
            
            showLoading(true);
            const url = buildPath(deptId, classId, studentId) + '/chain';
            console.log('[VIEW_CHAIN] Requesting URL:', url);
            const data = await fetchData(url);
            console.log('[VIEW_CHAIN] Response data:', data);
            showLoading(false);

            const blockchainDataEl = document.getElementById('blockchain-data');
            console.log('[VIEW_CHAIN] blockchainDataEl:', blockchainDataEl);
            console.log('[VIEW_CHAIN] history-view hidden status:', document.getElementById('history-view').classList.contains('hidden'));
            blockchainDataEl.innerHTML = '';

            if (data && data.blocks) {
                console.log('[VIEW_CHAIN] Found', data.blocks.length, 'blocks');
                if (data.blocks.length === 0) {
                    blockchainDataEl.innerHTML = '<p class="text-center text-gray-500 p-8">No blocks found in this student chain. This should not happen - each student should have at least a genesis block.</p>';
                    return;
                }
                
                let htmlContent = '';
                console.log('[VIEW_CHAIN] Starting to render', data.blocks.length, 'blocks');
                data.blocks.forEach((block, idx) => {
                    if (idx === 0 || idx === data.blocks.length - 1) {
                        console.log(`[VIEW_CHAIN] Rendering block ${idx}/${data.blocks.length}:`, block);
                    }
                    const blockType = block.transactions?.type || 'GENESIS';
                    let statusColor = 'bg-indigo-100 border-indigo-300';

                    if (blockType === 'GENESIS') {
                        statusColor = 'bg-indigo-100 border-indigo-300';
                    } else if (blockType === 'ATTENDANCE_RECORD') {
                        if (block.transactions?.status === 'Present') {
                            statusColor = 'bg-green-100 border-green-300';
                        } else if (block.transactions?.status === 'Absent') {
                            statusColor = 'bg-red-100 border-red-300';
                        } else if (block.transactions?.status === 'Leave') {
                            statusColor = 'bg-yellow-100 border-yellow-300';
                        } else {
                            statusColor = 'bg-blue-100 border-blue-300';
                        }
                    } else if (blockType && blockType.includes('DELETE')) {
                        statusColor = 'bg-red-100 border-red-300';
                    } else if (blockType && blockType.includes('UPDATE')) {
                        statusColor = 'bg-orange-100 border-orange-300';
                    }

                    htmlContent += `
                        <div class="${statusColor} p-4 rounded-lg border-l-4 card-shadow">
                            <div class="flex justify-between items-start">
                                <span class="font-bold text-lg">Block #${block.index} (${blockType})</span>
                                <span class="text-xs text-gray-500">${new Date(block.timestamp).toLocaleString()}</span>
                            </div>
                            
                            <p class="mt-2 text-sm text-gray-700"><strong>Transactions:</strong> ${JSON.stringify(block.transactions).substring(0, 200)}...</p>
                            
                            <p class="text-xs text-gray-500 mt-3 break-all"><strong>Hash:</strong> ${block.hash}</p>
                            <p class="text-xs text-gray-500 break-all"><strong>Prev Hash:</strong> ${block.prev_hash || '---'}</p>
                            <p class="text-xs text-gray-500"><strong>Nonce:</strong> ${block.nonce || '---'}</p>
                        </div>
                    `;
                });
                
                console.log('[VIEW_CHAIN] Setting innerHTML with', data.blocks.length, 'blocks');
                blockchainDataEl.innerHTML = htmlContent;
                console.log('[VIEW_CHAIN] innerHTML set. Element now contains:', blockchainDataEl.innerHTML.length, 'characters');
            } else {
                blockchainDataEl.innerHTML = '<p class="text-center text-gray-500 p-8">No blockchain data found for this student.</p>';
            }
        }

        document.getElementById('validation-btn').addEventListener('click', async () => {
            document.getElementById('validation-btn').textContent = "üîç Running Validation...";
            document.getElementById('validation-btn').disabled = true;
            
            const data = await fetchData(`${API_BASE_URL}/validate`);

            document.getElementById('validation-btn').textContent = "üõ°Ô∏è Run System Integrity Check";
            document.getElementById('validation-btn').disabled = false;

            if (data) {
                if (data.status === 'VALID') {
                    showMessage('success', data.message, "Full report available in console.");
                } else if (data.status === 'INVALID') {
                    // Assuming the backend sends status: 'INVALID' and a report on failure
                    showMessage('error', data.message, "Check the console for a detailed report on the compromised chains.");
                }
                console.log("--- BAMS Validation Report ---");
                console.log(data.report);
                console.log("--- End Report ---");
            }
        });

        // --- 3D Hierarchy Visualization ---
        let scene, camera, renderer, controls;
        const nodeObjects = {};

        function init3DVisualization() {
            console.log('[3D] Initializing 3D visualization...');
            const container = document.getElementById('canvas-container');
            if (!container) {
                console.error('[3D] Canvas container not found!');
                return;
            }

            console.log('[3D] Container found, size:', container.clientWidth, 'x', container.clientHeight);

            // Scene setup
            scene = new THREE.Scene();
            scene.background = new THREE.Color(0x667eea);
            scene.fog = new THREE.Fog(0x667eea, 500, 1000);

            // Camera setup
            const width = container.clientWidth;
            const height = container.clientHeight;
            camera = new THREE.PerspectiveCamera(75, width / height, 0.1, 10000);
            camera.position.set(0, 50, 100);
            camera.lookAt(0, 0, 0);

            // Renderer setup
            renderer = new THREE.WebGLRenderer({ antialias: true });
            renderer.setSize(width, height);
            renderer.setPixelRatio(window.devicePixelRatio);
            container.appendChild(renderer.domElement);
            console.log('[3D] Renderer created and added to DOM');

            // Lighting
            const ambientLight = new THREE.AmbientLight(0xffffff, 0.6);
            scene.add(ambientLight);

            const directionalLight = new THREE.DirectionalLight(0xffffff, 0.8);
            directionalLight.position.set(100, 100, 100);
            scene.add(directionalLight);
            console.log('[3D] Lighting added');

            // Simple orbit-like controls
            setupControls();

            // Create hierarchy
            loadAndVisualize3DTree();

            // Animation loop
            animate();
            console.log('[3D] Animation loop started');

            // Handle window resize
            window.addEventListener('resize', onWindowResize);
        }

        function setupControls() {
            let isDragging = false;
            let previousMousePosition = { x: 0, y: 0 };

            document.addEventListener('mousedown', (e) => {
                isDragging = true;
                previousMousePosition = { x: e.clientX, y: e.clientY };
            });

            document.addEventListener('mousemove', (e) => {
                if (isDragging) {
                    const deltaX = e.clientX - previousMousePosition.x;
                    const deltaY = e.clientY - previousMousePosition.y;

                    // Rotate camera
                    const radius = Math.sqrt(camera.position.x ** 2 + camera.position.y ** 2 + camera.position.z ** 2);
                    const theta = Math.atan2(camera.position.z, camera.position.x);
                    const phi = Math.acos(camera.position.y / radius);

                    const newTheta = theta + deltaX * 0.005;
                    const newPhi = Math.max(0.1, Math.min(Math.PI - 0.1, phi + deltaY * 0.005));

                    camera.position.x = radius * Math.sin(newPhi) * Math.cos(newTheta);
                    camera.position.y = radius * Math.cos(newPhi);
                    camera.position.z = radius * Math.sin(newPhi) * Math.sin(newTheta);
                    camera.lookAt(0, 0, 0);
                }
                previousMousePosition = { x: e.clientX, y: e.clientY };
            });

            document.addEventListener('mouseup', () => {
                isDragging = false;
            });

            document.addEventListener('wheel', (e) => {
                e.preventDefault();
                const radius = Math.sqrt(camera.position.x ** 2 + camera.position.y ** 2 + camera.position.z ** 2);
                const newRadius = radius + e.deltaY * 0.1;
                const factor = newRadius / radius;

                camera.position.multiplyScalar(factor);
                camera.lookAt(0, 0, 0);
            }, { passive: false });
        }

        async function loadAndVisualize3DTree() {
            console.log('[3D] Starting to load hierarchy...');
            // Fetch all departments
            const deptsData = await fetchData(`${API_BASE_URL}/departments`);
            console.log('[3D] Departments data:', deptsData);
            
            // Check if deptsData is an array or has a departments property
            const departments = Array.isArray(deptsData) ? deptsData : (deptsData?.departments || []);
            
            if (!departments || departments.length === 0) {
                console.error('[3D] No departments data returned');
                return;
            }

            console.log('[3D] Creating visualization for', departments.length, 'departments');
            let yOffset = 0;
            let xOffset = -150;

            for (const dept of departments) {
                console.log('[3D] Processing department:', dept.name);
                // Create department node
                const deptNode = createSphere(xOffset, yOffset, 0, 20, 0x00aa00); // Green
                nodeObjects[`dept-${dept.name}`] = deptNode;
                const deptLabel = createTextSprite(dept.name, 0xffffff);
                deptLabel.position.copy(deptNode.position);
                deptLabel.position.y += 30;
                scene.add(deptLabel);

                // Fetch classes for this department
                const classesData = await fetchData(`${API_BASE_URL}/departments/${dept.id}/classes`);
                console.log('[3D] Classes for', dept.name, ':', classesData);
                
                // Check if classesData is an array or has a classes property
                const classes = Array.isArray(classesData) ? classesData : (classesData?.classes || []);
                
                if (classes && classes.length > 0) {
                    let classYOffset = yOffset - 60;
                    let classXOffset = xOffset - 100;

                    for (let i = 0; i < classes.length; i++) {
                        const cls = classes[i];
                        console.log('[3D] Processing class:', cls.name);
                        const classNode = createSphere(classXOffset, classYOffset, 50, 15, 0x0066ff); // Blue
                        nodeObjects[`class-${cls.name}`] = classNode;

                        // Draw line from dept to class
                        drawLine(deptNode.position, classNode.position, 0x888888);

                        const classLabel = createTextSprite(cls.name.substring(0, 8), 0xffffff);
                        classLabel.position.copy(classNode.position);
                        classLabel.position.y += 25;
                        scene.add(classLabel);

                        // Fetch students for this class
                        const studentsData = await fetchData(`${API_BASE_URL}/departments/${dept.id}/classes/${cls.id}/students`);
                        console.log('[3D] Students for', cls.name, ':', studentsData);
                        
                        // Check if studentsData is an array or has a students property
                        const students = Array.isArray(studentsData) ? studentsData : (studentsData?.students || []);
                        
                        if (students && students.length > 0) {
                            let studentYOffset = classYOffset - 40;
                            let studentXOffset = classXOffset - 50;

                            for (let j = 0; j < Math.min(students.length, 5); j++) {
                                const student = students[j];
                                const studentNode = createSphere(studentXOffset + j * 30, studentYOffset, 100, 10, 0xff9933); // Orange
                                nodeObjects[`student-${student.name}`] = studentNode;

                                // Draw line from class to student
                                drawLine(classNode.position, studentNode.position, 0x666666);

                                const studentLabel = createTextSprite(student.name.substring(0, 5), 0xffffff);
                                studentLabel.position.copy(studentNode.position);
                                studentLabel.position.y += 15;
                                scene.add(studentLabel);
                            }
                        }

                        classYOffset -= 50;
                        if (i % 2 === 1) {
                            classXOffset += 150;
                            classYOffset = yOffset - 60;
                        }
                    }
                }

                xOffset += 300;
            }
            console.log('[3D] Hierarchy visualization complete. Total nodes:', Object.keys(nodeObjects).length);
        }

        function createSphere(x, y, z, size, color) {
            const geometry = new THREE.SphereGeometry(size, 32, 32);
            const material = new THREE.MeshPhongMaterial({ color });
            const mesh = new THREE.Mesh(geometry, material);
            mesh.position.set(x, y, z);
            scene.add(mesh);
            console.log('[3D] Created sphere at', x, y, z, 'with size', size, 'color', color.toString(16));
            return mesh;
        }

        function createTextSprite(text, color) {
            const canvas = document.createElement('canvas');
            const context = canvas.getContext('2d');
            canvas.width = 256;
            canvas.height = 64;

            context.fillStyle = '#' + color.toString(16).padStart(6, '0');
            context.font = 'bold 40px Arial';
            context.textAlign = 'center';
            context.textBaseline = 'middle';
            context.fillText(text, 128, 32);

            const texture = new THREE.CanvasTexture(canvas);
            const geometry = new THREE.PlaneGeometry(40, 10);
            const material = new THREE.MeshBasicMaterial({ map: texture, transparent: true });
            const sprite = new THREE.Mesh(geometry, material);
            return sprite;
        }

        function drawLine(start, end, color) {
            const geometry = new THREE.BufferGeometry();
            geometry.setAttribute('position', new THREE.BufferAttribute(new Float32Array([
                start.x, start.y, start.z,
                end.x, end.y, end.z
            ]), 3));
            const material = new THREE.LineBasicMaterial({ color });
            const line = new THREE.Line(geometry, material);
            scene.add(line);
        }

        function animate() {
            requestAnimationFrame(animate);
            renderer.render(scene, camera);
        }

        function onWindowResize() {
            if (!renderer) return;
            const container = document.getElementById('canvas-container');
            if (!container) return;

            const width = container.clientWidth;
            const height = container.clientHeight;
            camera.aspect = width / height;
            camera.updateProjectionMatrix();
            renderer.setSize(width, height);
        }

        // --- Initialization ---
        window.onload = () => {
            setView('departments');
        };

    </script>
</body>
</html>