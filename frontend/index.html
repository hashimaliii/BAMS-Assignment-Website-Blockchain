<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>BAMS Hierarchy Dashboard</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;800&display=swap" rel="stylesheet">
    <style>
        /* Apply the Inter font globally */
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f4f7fa; /* Light background for the overall page */
        }
        
        /* Custom Tailwind Configuration for shadow and backgrounds */
        .container-bg {
            background-color: #ffffff; /* White card background */
            border: 1px solid #e5e7eb; /* Light border */
        }
        
        .card-shadow {
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -2px rgba(0, 0, 0, 0.06);
            transition: transform 0.2s, box-shadow 0.2s;
        }

        .card-shadow:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -4px rgba(0, 0, 0, 0.1);
        }

        /* Primary Button Style */
        .btn-primary {
            background-color: #3b82f6; /* Blue-600 */
            color: white;
            transition: background-color 0.15s ease-in-out;
        }
        
        .btn-primary:hover {
            background-color: #2563eb; /* Blue-700 */
        }

        /* Ensure sticky header looks good on scroll */
        header {
            background-color: #f4f7fa; /* Match body background */
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
        }
    </style>
</head>
<body class="min-h-screen p-4 md:p-8">

    <div id="app" class="max-w-7xl mx-auto">
        
        <!-- Header & Global Actions -->
        <header class="container-bg p-6 mb-8 rounded-xl flex flex-col md:flex-row justify-between items-start md:items-center sticky top-0 z-10">
            <h1 class="text-3xl font-extrabold text-gray-800 mb-4 md:mb-0">
                <span class="text-blue-600">BAMS</span> Hierarchy Dashboard
            </h1>
            <div class="flex flex-wrap gap-3">
                <button id="validation-btn" class="btn-primary px-5 py-2 rounded-lg font-semibold text-sm shadow-md">
                    üõ°Ô∏è Run System Integrity Check
                </button>
                <button id="home-btn" class="bg-gray-200 text-gray-700 hover:bg-gray-300 px-5 py-2 rounded-lg font-semibold text-sm shadow-md" onclick="setView('departments')">
                    üè† Home
                </button>
            </div>
        </header>

        <!-- Message/Status Area -->
        <div id="message-area" class="mb-6 p-4 rounded-lg text-sm transition-all duration-300 ease-in-out hidden"></div>

        <!-- Breadcrumbs -->
        <div id="breadcrumbs" class="mb-6 text-gray-600 text-sm font-medium"></div>

        <!-- Main Content Area -->
        <div id="main-content">
            <h2 class="text-2xl font-bold text-gray-700 mb-4" id="current-view-title">Departments</h2>
            
            <div id="loading-indicator" class="text-center py-12 text-gray-500 hidden">
                <div class="animate-spin inline-block w-8 h-8 border-4 border-blue-500 border-t-transparent rounded-full"></div>
                <p class="mt-2">Loading data...</p>
            </div>
            
            <!-- List View (Departments, Classes, Students) -->
            <div id="list-view" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                <!-- Content injected here -->
            </div>

            <!-- Attendance/History View (Student details and blockchain data) -->
            <div id="history-view" class="hidden">
                <!-- Student Details and Attendance Form -->
                <div id="student-details-card" class="container-bg p-6 rounded-xl mb-6 card-shadow"></div>
                
                <h3 class="text-xl font-bold text-gray-700 mb-3 mt-8">Blockchain Ledger (Student Chain)</h3>
                <div id="blockchain-data" class="space-y-4">
                    <!-- Blocks injected here -->
                </div>
            </div>
        </div>
    </div>

    <!-- Modals (Simple structure for demonstration) -->
    <div id="modal-container" class="hidden fixed inset-0 bg-gray-900 bg-opacity-50 flex items-center justify-center p-4 z-50">
        <div class="bg-white p-8 rounded-xl w-full max-w-lg">
            <h3 id="modal-title" class="text-xl font-bold mb-4">Modal Title</h3>
            <div id="modal-content">Modal Content</div>
            <div class="mt-6 flex justify-end gap-3">
                <button id="modal-close" class="bg-gray-300 text-gray-700 hover:bg-gray-400 px-4 py-2 rounded-lg">Close</button>
            </div>
        </div>
    </div>

    <script>
        const API_BASE_URL = 'http://localhost:3000/api';
        
        // --- Application State ---
        let currentState = {
            view: 'departments', // 'departments', 'classes', 'students', 'history'
            deptId: null,
            className: null,
            classId: null,
            studentId: null,
            studentName: null,
        };
        
        // --- Utility Functions ---

        function showLoading(show) {
            document.getElementById('loading-indicator').classList.toggle('hidden', !show);
            document.getElementById('list-view').classList.toggle('hidden', show);
            document.getElementById('history-view').classList.add('hidden');
        }

        function showMessage(type, message, details = '') {
            const area = document.getElementById('message-area');
            
            // --- FIX FOR InvalidCharacterError (Issue 3) ---
            // 1. Remove ALL classes first to ensure a clean slate.
            area.className = 'mb-6 p-4 rounded-lg text-sm transition-all duration-300 ease-in-out';
            // 2. Add 'hidden' back if the message is empty (though it shouldn't be).
            if (!message) {
                area.classList.add('hidden');
                return;
            }
            
            let classes = [];
            if (type === 'error') {
                classes = ['bg-red-100', 'border', 'border-red-400', 'text-red-700'];
            } else if (type === 'success') {
                classes = ['bg-green-100', 'border', 'border-green-400', 'text-green-700'];
            } else if (type === 'info') {
                classes = ['bg-blue-100', 'border', 'border-blue-400', 'text-blue-700'];
            } else if (type === 'warning') {
                classes = ['bg-yellow-100', 'border', 'border-yellow-400', 'text-yellow-700'];
            }

            // Apply classes one by one to avoid issues with space characters
            classes.forEach(cls => area.classList.add(cls));
            
            area.innerHTML = `<strong>${message}</strong> ${details ? `<br><span class="block mt-1">${details}</span>` : ''}`;
            
            // Show the message area
            area.classList.remove('hidden');

            // Auto-hide success/info messages
            if (type === 'success' || type === 'info') {
                setTimeout(() => area.classList.add('hidden'), 5000);
            }
        }

        function buildPath(id, classId, studentId) {
            let url = API_BASE_URL;
            if (id) {
                url += `/departments/${id}`;
            }
            if (classId) {
                url += `/classes/${classId}`;
            }
            if (studentId) {
                url += `/students/${studentId}`;
            }
            return url;
        }

        async function fetchData(url, method = 'GET', body = null) {
            try {
                const options = {
                    method,
                    headers: { 'Content-Type': 'application/json' },
                };
                if (body) {
                    options.body = JSON.stringify(body);
                }

                const response = await fetch(url, options);
                
                if (response.status === 204) {
                    return { success: true, message: "Operation successful, no content returned." };
                }

                const data = await response.json();

                if (!response.ok) {
                    // Handle 400 Bad Request
                    if (response.status === 400) {
                         throw new Error(`Bad Request (400): ${data.error || 'Server rejected the request. Check your input.'}`);
                    }
                    // Check if it's a 500 error from validation and provide a specific message
                    if (response.status === 500 && url.endsWith('/validate')) {
                        throw new Error(`System validation failed on the server side (500 Error). Report: ${JSON.stringify(data.report || data.error)}`);
                    }
                    throw new Error(data.error || `HTTP error! Status: ${response.status}`);
                }
                
                return data;
            } catch (error) {
                console.error("Fetch Error:", error);
                // The fix in showMessage allows this to display correctly now
                showMessage('error', `API Request Failed:`, error.message); 
                return null;
            }
        }

        // --- View Logic ---

        function updateBreadcrumbs() {
            let html = '<span class="cursor-pointer hover:text-blue-600" onclick="setView(\'departments\')">Departments</span>';
            
            if (currentState.deptId) {
                // Attempt to find the department name from the currently rendered cards if possible
                const deptCard = document.querySelector(`.dept-card[data-id="${currentState.deptId}"]`);
                const deptName = deptCard ? deptCard.querySelector('h3').textContent : currentState.deptId;

                html += ` <span class="mx-1">/</span> <span class="cursor-pointer hover:text-blue-600" onclick="setView('classes', '${currentState.deptId}')">${deptName}</span>`;
            }

            if (currentState.classId) {
                html += ` <span class="mx-1">/</span> <span class="cursor-pointer hover:text-blue-600" onclick="setView('students', '${currentState.deptId}', '${currentState.classId}')">${currentState.classId}</span>`;
            }

            if (currentState.view === 'history') {
                html += ` <span class="mx-1">/</span> <span class="text-blue-600">${currentState.studentName || currentState.studentId} (Ledger)</span>`;
            }
            document.getElementById('breadcrumbs').innerHTML = html;
        }


        function setView(view, deptId = null, classId = null, studentId = null, studentName = null) {
            currentState.view = view;
            currentState.deptId = deptId;
            currentState.classId = classId;
            currentState.studentId = studentId;
            currentState.studentName = studentName;
            
            // Hide all content containers
            document.getElementById('list-view').classList.remove('hidden');
            document.getElementById('history-view').classList.add('hidden');
            
            document.getElementById('list-view').innerHTML = '';
            
            document.getElementById('list-view').classList.remove('grid-cols-1', 'md:grid-cols-2', 'lg:grid-cols-3');
            
            switch (view) {
                case 'departments':
                    document.getElementById('current-view-title').textContent = 'Departments (Layer 1 Chains)';
                    document.getElementById('list-view').classList.add('grid-cols-1', 'md:grid-cols-2', 'lg:grid-cols-3');
                    fetchDepartments();
                    break;
                case 'classes':
                    document.getElementById('current-view-title').textContent = `Classes in ${deptId} (Layer 2 Chains)`;
                    document.getElementById('list-view').classList.add('grid-cols-1', 'md:grid-cols-2');
                    fetchClasses(deptId);
                    break;
                case 'students':
                    document.getElementById('current-view-title').textContent = `Students in ${classId} (Layer 3 Chains)`;
                    document.getElementById('list-view').classList.add('grid-cols-1'); // Student list is better as a single column table/list
                    fetchStudents(deptId, classId);
                    break;
                case 'history':
                    document.getElementById('current-view-title').textContent = `Attendance Ledger for ${studentName || studentId}`;
                    document.getElementById('list-view').classList.add('hidden');
                    document.getElementById('history-view').classList.remove('hidden');
                    fetchStudentHistory(deptId, classId, studentId, studentName);
                    break;
            }
            updateBreadcrumbs();
        }

        // --- API Calls and Renderers ---

        async function fetchDepartments() {
            showLoading(true);
            const data = await fetchData(`${API_BASE_URL}/departments`);
            showLoading(false);
            
            if (data) {
                document.getElementById('list-view').innerHTML = renderDepartmentList(data);
            }
        }

        function renderDepartmentList(departments) {
            let html = departments.map(dept => `
                <div class="dept-card container-bg p-6 rounded-xl card-shadow flex flex-col justify-between" data-id="${dept.id}">
                    <div>
                        <h3 class="text-xl font-bold text-blue-600 mb-1">${dept.name}</h3>
                        <p class="text-gray-500 text-sm">ID: ${dept.id}</p>
                        <p class="text-xs text-gray-400 mt-2 truncate">Latest Hash: ${dept.currentHash}</p>
                    </div>
                    <div class="mt-4 flex flex-col gap-2">
                        <button class="btn-primary w-full px-3 py-1 rounded-lg text-sm font-medium" onclick="setView('classes', '${dept.id}')">
                            View Classes (Layer 2)
                        </button>
                        <div class="flex gap-2">
                            <button class="bg-yellow-500 text-white hover:bg-yellow-600 px-3 py-1 rounded-lg text-xs" onclick="openCrudModal('Update Department', 'PUT', '${dept.id}')">Edit</button>
                            <button class="bg-red-500 text-white hover:bg-red-600 px-3 py-1 rounded-lg text-xs" onclick="confirmDelete('Department', '${dept.id}')">Delete</button>
                        </div>
                    </div>
                </div>
            `).join('');

            // Add button for creating new department
            html += `
                <div class="bg-white border-2 border-dashed border-gray-300 rounded-xl p-6 flex items-center justify-center cursor-pointer hover:bg-gray-50 transition duration-150"
                     onclick="openCrudModal('Add New Department', 'POST')">
                    <span class="text-gray-500 text-lg font-medium">+ Add Department</span>
                </div>
            `;
            return html;
        }

        async function fetchClasses(deptId) {
            showLoading(true);
            const data = await fetchData(`${API_BASE_URL}/departments/${deptId}/classes`);
            showLoading(false);
            
            if (data) {
                document.getElementById('list-view').innerHTML = renderClassList(data, deptId);
            }
        }

        function renderClassList(classes, deptId) {
            let html = classes.map(cls => `
                <div class="container-bg p-6 rounded-xl card-shadow flex flex-col justify-between">
                    <div>
                        <h3 class="text-xl font-bold text-green-600 mb-1">${cls.name}</h3>
                        <p class="text-gray-500 text-sm">ID: ${cls.id}</p>
                        <p class="text-xs text-gray-400 mt-2 truncate">Latest Hash: ${cls.currentHash}</p>
                    </div>
                    <div class="mt-4 flex flex-col gap-2">
                        <button class="btn-primary w-full px-3 py-1 rounded-lg text-sm font-medium" onclick="setView('students', '${deptId}', '${cls.id}')">
                            View Students (Layer 3)
                        </button>
                        <div class="flex gap-2">
                            <button class="bg-yellow-500 text-white hover:bg-yellow-600 px-3 py-1 rounded-lg text-xs" onclick="openCrudModal('Update Class', 'PUT', '${deptId}', '${cls.id}')">Edit</button>
                            <button class="bg-red-500 text-white hover:bg-red-600 px-3 py-1 rounded-lg text-xs" onclick="confirmDelete('Class', '${deptId}', '${cls.id}')">Delete</button>
                        </div>
                    </div>
                </div>
            `).join('');

            html += `
                <div class="bg-white border-2 border-dashed border-gray-300 rounded-xl p-6 flex items-center justify-center cursor-pointer hover:bg-gray-50 transition duration-150"
                     onclick="openCrudModal('Add New Class', 'POST', '${deptId}')">
                    <span class="text-gray-500 text-lg font-medium">+ Add Class</span>
                </div>
            `;
            return html;
        }

        async function fetchStudents(deptId, classId) {
            showLoading(true);
            const data = await fetchData(`${API_BASE_URL}/departments/${deptId}/classes/${classId}/students`);
            showLoading(false);

            if (data) {
                document.getElementById('list-view').innerHTML = renderStudentList(data, deptId, classId);
            }
        }

        function renderStudentList(students, deptId, classId) {
            let html = `
                <div class="lg:col-span-3">
                <div class="bg-white p-6 rounded-xl card-shadow overflow-x-auto">
                    <table class="min-w-full divide-y divide-gray-200">
                        <thead class="bg-gray-50">
                            <tr>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Name</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Roll No</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Student ID</th>
                                <th class="px-6 py-3 text-center text-xs font-medium text-gray-500 uppercase tracking-wider">Attendance</th>
                                <th class="px-6 py-3 text-center text-xs font-medium text-gray-500 uppercase tracking-wider">Actions</th>
                            </tr>
                        </thead>
                        <tbody class="divide-y divide-gray-200">
            `;

            if (students.length === 0) {
                html += `<tr><td colspan="5" class="p-4 text-center text-gray-500">No students found.</td></tr>`;
            } else {
                html += students.map(student => `
                    <tr class="hover:bg-gray-50">
                        <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">${student.name}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${student.rollNumber}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${student.id}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-center">
                            <select id="status-${student.id}" class="p-1 border rounded text-sm focus:ring-blue-500 focus:border-blue-500">
                                <option value="Present">Present</option>
                                <option value="Absent">Absent</option>
                                <option value="Leave">Leave</option>
                            </select>
                            <button class="bg-blue-500 text-white hover:bg-blue-600 px-3 py-1 ml-2 rounded text-xs font-medium" 
                                onclick="markAttendance('${deptId}', '${classId}', '${student.id}')">Mark</button>
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap text-center text-sm font-medium">
                            <button class="text-blue-600 hover:text-blue-900 text-xs mr-3" onclick="setView('history', '${deptId}', '${classId}', '${student.id}', '${student.name}')">View Ledger</button>
                            <button class="text-yellow-600 hover:text-yellow-900 text-xs mr-3" onclick="openCrudModal('Update Student', 'PUT', '${deptId}', '${classId}', '${student.id}')">Edit</button>
                            <button class="text-red-600 hover:text-red-900 text-xs" onclick="confirmDelete('Student', '${deptId}', '${classId}', '${student.id}')">Delete</button>
                        </td>
                    </tr>
                `).join('');
            }

            html += `
                        </tbody>
                    </table>
                </div>
                
                <div class="mt-4">
                    <button class="bg-gray-200 text-gray-700 hover:bg-gray-300 px-4 py-2 rounded-lg font-semibold text-sm shadow-md"
                        onclick="openCrudModal('Add New Student', 'POST', '${deptId}', '${classId}')">
                        + Add Student
                    </button>
                </div>
            </div>`;
            return html;
        }

        // --- CRUD and Attendance Functions ---

        function openCrudModal(title, method, deptId, classId = null, itemId = null) {
            const container = document.getElementById('modal-container');
            const modalTitle = document.getElementById('modal-title');
            const modalContent = document.getElementById('modal-content');
            
            modalTitle.textContent = title;
            modalContent.innerHTML = `
                <form id="crud-form">
                    ${!classId ? `
                        <label class="block text-gray-700 text-sm font-bold mb-2">Department ID</label>
                        <input type="text" name="deptId" class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 mb-4" placeholder="e.g., MATH" value="${itemId || ''}" ${itemId && method === 'PUT' ? 'disabled' : ''}>
                        <label class="block text-gray-700 text-sm font-bold mb-2">Department Name</label>
                        <input type="text" name="name" class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 mb-4" placeholder="e.g., School of Mathematics">
                    ` : classId && !itemId ? `
                        <p class="text-xs text-gray-500 mb-4">Under Department: <strong>${deptId}</strong></p>
                        <label class="block text-gray-700 text-sm font-bold mb-2">Class ID</label>
                        <input type="text" name="classId" class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 mb-4" placeholder="e.g., MATH-101">
                        <label class="block text-gray-700 text-sm font-bold mb-2">Class Name</label>
                        <input type="text" name="name" class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 mb-4" placeholder="e.g., Calculus I">
                    ` : classId && itemId && title.includes('Student') ? `
                        <p class="text-xs text-gray-500 mb-4">Under Class: <strong>${classId}</strong></p>
                        <label class="block text-gray-700 text-sm font-bold mb-2">Student ID</label>
                        <input type="text" name="studentId" class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 mb-4" placeholder="e.g., S-001" value="${itemId || ''}" disabled>
                        <label class="block text-gray-700 text-sm font-bold mb-2">Name</label>
                        <input type="text" name="name" class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 mb-4" placeholder="e.g., Jane Doe">
                        <label class="block text-gray-700 text-sm font-bold mb-2">Roll Number</label>
                        <input type="number" name="rollNumber" class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 mb-4" placeholder="e.g., 20251001">
                    ` : `
                        <p class="text-xs text-gray-500 mb-4">Generic update form. Only submit fields you wish to change.</p>
                        <label class="block text-gray-700 text-sm font-bold mb-2">Name</label>
                        <input type="text" name="name" class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 mb-4" placeholder="New Name">
                    `}
                    <button type="submit" class="btn-primary w-full py-2 rounded-lg font-semibold mt-4">Submit</button>
                </form>
            `;

            document.getElementById('modal-close').onclick = () => container.classList.add('hidden');
            
            document.getElementById('crud-form').onsubmit = (e) => handleCrudSubmit(e, method, deptId, classId, itemId);

            container.classList.remove('hidden');
        }

        async function handleCrudSubmit(e, method, deptId, classId, itemId) {
            e.preventDefault();
            const form = e.target;
            const formData = new FormData(form);
            const body = {};
            
            formData.forEach((value, key) => {
                // For PUT, only send non-empty fields
                if (method === 'PUT' && key !== 'deptId' && key !== 'classId' && value) {
                    body[key] = value;
                } else if (method === 'POST') {
                    body[key] = value;
                }
            });

            // Determine URL and ID for POST
            let url = '';
            let id = deptId;

            if (method === 'POST') {
                if (!classId) { // Add Department
                    url = buildPath();
                    id = body.deptId;
                } else if (!itemId) { // Add Class
                    url = buildPath(deptId);
                    id = body.classId;
                } else { // Add Student
                    url = buildPath(deptId, classId);
                    id = body.studentId;
                }
            } else if (method === 'PUT') {
                if (!classId) { // Update Department
                    url = buildPath(deptId);
                } else if (!itemId) { // Update Class
                    url = buildPath(deptId, classId);
                } else { // Update Student
                    url = buildPath(deptId, classId, itemId);
                }
            }

            const result = await fetchData(url, method, body);
            document.getElementById('modal-container').classList.add('hidden');

            if (result) {
                showMessage('success', result.message);
                // Refresh the current view
                setView(currentState.view, currentState.deptId, currentState.classId);
            }
        }

        function confirmDelete(type, deptId, classId = null, itemId = null) {
            const name = itemId || classId || deptId;
            // Using a simple window.confirm as a temporary placeholder for a custom modal
            if (window.confirm(`Are you sure you want to logically delete ${type} [${name}]? This action creates an immutable 'deleted' block.`)) {
                handleDelete(type, deptId, classId, itemId);
            }
        }

        async function handleDelete(type, deptId, classId = null, itemId = null) {
            let url = '';
            if (type === 'Department') {
                url = buildPath(deptId);
            } else if (type === 'Class') {
                url = buildPath(deptId, classId);
            } else if (type === 'Student') {
                url = buildPath(deptId, classId, itemId);
            }

            // The backend error should be resolved by correcting the service file.
            const result = await fetchData(url, 'DELETE');
            
            if (result) {
                showMessage('success', result.message);
                // Refresh the current view
                setView(currentState.view, currentState.deptId, currentState.classId);
            }
        }


        async function markAttendance(deptId, classId, studentId) {
            const status = document.getElementById(`status-${studentId}`).value;
            const url = buildPath(deptId, classId, studentId) + '/attendance';
            
            const result = await fetchData(url, 'POST', { status });

            if (result) {
                showMessage('success', `Attendance marked as ${status}. Block Hash:`, result.blockHash.substring(0, 10) + '...');
            }
        }

        // --- History and Validation ---

        async function fetchStudentHistory(deptId, classId, studentId, studentName) {
            document.getElementById('student-details-card').innerHTML = `
                <p class="text-xl font-bold">${studentName}</p>
                <p class="text-gray-500">ID: ${studentId} | Class: ${classId} | Dept: ${deptId}</p>
            `;
            
            showLoading(true);
            const data = await fetchData(buildPath(deptId, classId, studentId) + '/history');
            showLoading(false);

            const blockchainDataEl = document.getElementById('blockchain-data');
            blockchainDataEl.innerHTML = '';

            if (data && data.history) {
                data.history.forEach(block => {
                    const blockType = block.transactions?.type;
                    const isAttendance = blockType === 'ATTENDANCE_RECORD';
                    
                    let statusColor = 'bg-gray-100 border-gray-300';
                    let statusIcon = '‚ÑπÔ∏è';

                    if (isAttendance) {
                        if (block.status === 'Present') {
                            statusColor = 'bg-green-100 border-green-300';
                            statusIcon = '‚úÖ';
                        } else if (block.status === 'Absent') {
                            statusColor = 'bg-red-100 border-red-300';
                            statusIcon = '‚ùå';
                        } else if (block.status === 'Leave') {
                            statusColor = 'bg-yellow-100 border-yellow-300';
                            statusIcon = 'üü°';
                        }
                    } else if (blockType && blockType.includes('DELETE')) {
                        statusColor = 'bg-red-100 border-red-300';
                        statusIcon = 'üóëÔ∏è';
                    }

                    blockchainDataEl.innerHTML += `
                        <div class="${statusColor} p-4 rounded-lg border-l-4 card-shadow">
                            <div class="flex justify-between items-start">
                                <span class="font-bold text-lg">${statusIcon} Block #${block.index} (${blockType})</span>
                                <span class="text-xs text-gray-500">${new Date(block.timestamp).toLocaleString()}</span>
                            </div>
                            
                            <p class="mt-2 text-sm text-gray-700"><strong>Status:</strong> ${block.status || 'Metadata Update'}</p>
                            <p class="text-sm text-gray-700"><strong>Date:</strong> ${block.date || 'N/A'}</p>
                            
                            <p class="text-xs text-gray-500 mt-3 break-all"><strong>Hash:</strong> ${block.hash}</p>
                            <p class="text-xs text-gray-500 break-all"><strong>Prev Hash:</strong> ${block.prev_hash || '---'}</p>
                            <p class="text-xs text-gray-500"><strong>Nonce:</strong> ${block.nonce || '---'}</p>
                        </div>
                    `;
                });
            } else {
                blockchainDataEl.innerHTML = '<p class="text-center text-gray-500 p-8">No blockchain data found for this student.</p>';
            }
        }


        document.getElementById('validation-btn').addEventListener('click', async () => {
            document.getElementById('validation-btn').textContent = "üîç Running Validation...";
            document.getElementById('validation-btn').disabled = true;
            
            const data = await fetchData(`${API_BASE_URL}/validate`);

            document.getElementById('validation-btn').textContent = "üõ°Ô∏è Run System Integrity Check";
            document.getElementById('validation-btn').disabled = false;

            if (data) {
                if (data.status === 'VALID') {
                    showMessage('success', data.message, "Full report available in console.");
                } else if (data.status === 'INVALID') {
                    // Assuming the backend sends status: 'INVALID' and a report on failure
                    showMessage('error', data.message, "Check the console for a detailed report on the compromised chains.");
                }
                console.log("--- BAMS Validation Report ---");
                console.log(data.report);
                console.log("--- End Report ---");
            }
        });

        // --- Initialization ---
        window.onload = () => {
            setView('departments');
        };

    </script>
</body>
</html>